---
title: "Ribostan"
output: 
 html_notebook:
  toc: yes
---
  
# Vignette RiboEM
  
# Setup
  
```{r loadinglibraries, include=FALSE, echo=FALSE, eval=T}
library(Ribostan)
```



```{r}

{
#
source('R/anno.R')
fafile = '/fast/AG_Ohler/dharnet/eif4f_pipeline/GRCh38.primary_assembly.genome.fa'
anno <- load_annotation(fafile, fafile)
}

source('R/get_offsets.R')
source('R/get_ritpms.R')
#
cov <- get_readgr(ribobam, anno)
offsets_df <- get_offsets(cov, anno)
psites <- get_psite_gr(get_psite_gr, offsets_df, anno)
#
{
source('R/get_ritpms.R')
#
ritpms <- get_ritpms(ritpm_opt)
gritpms = gene_level_expr(ritpms, anno)
}

{
source(('R/model_TE.R'))
source('R/get_offsets.R')
source('R/get_ritpms.R')
ribocovtrs <- ritpms%>%Filter(f=function(x)x>10)%>%names
mainORFs <- anno$trgiddf%>%filter(!uORF)%>%.$transcript_id
ribocovtrs <- intersect(ribocovtrs, mainORFs)
#save.image('dev.Rdata')
#
rust_codon_occ_df <- get_codon_occs(psites, offsets_df, anno,
  n_genes=1000, method='RUST_glm')
tr_elong = get_predicted_codon_occs(anno, fafile, rust_codon_occ_df)
gn_elong = gene_level_elong(tr_elong, ritpms, anno)
}

{
selreadlens=27:33
source('R/kl_div.R')
covgrs = list(sample1=sampled_cov_gr)
kl_df<-get_kl_df(fprustprofilelist)
kl_offsets <- select_offsets(kl_df)
kl_offsets%>%select(p_offset,length=nreadlen)%>%readr::write_tsv('offsets_rustvar.tsv')
#
kl_div_plot <- plot_kl_dv(kl_df, kl_offsets, selreadlens)
#
# pdf<-grDevices::pdf
# dir.create('plots')
# plotfile='plots/rust_fppos_vs_codon_variance.pdf'
# pdf(plotfile,w=12,h=1+3*length(selreadlens))
kl_div_plot%>%print
# dev.off()
# message(normalizePath(plotfile))
#
allcodondt <- export_codon_dts(fprustprofilelist, kl_offsets)
allcodondt %>% readr::write_tsv('allcodondt.tsv')
#
}

{

}

#annotation
#data loading
#offsets
#Metaplots
#Kl plot
#quantification
#Detect Periodicity
#Gene level Elong

```
